version: '3.8'

# ============================================
# OpenClaw Stack - Monitoring & Observability
# ============================================
#
# Services:
# - Prometheus (metrics collection)
# - Grafana (dashboards)
# - Loki (logs aggregation)
# - Uptime Kuma (uptime monitoring)
# - Langfuse (LLM observability)
#
# RAM requirement: ~2-3 GB additional
# Dependencies: postgres (shared from core stack)
# Usage:
#   docker compose -f docker-compose.core.yml -f docker-compose.monitoring.yml up -d

services:
  # ============================================
  # Monitoring - Prometheus
  # ============================================
  
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    networks:
      - backend

  # ============================================
  # Monitoring - Grafana
  # ============================================
  
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GF_SECURITY_ADMIN_PASSWORD}
      GF_SERVER_ROOT_URL: https://${DOMAIN}/grafana
      GF_SERVER_SERVE_FROM_SUB_PATH: 'true'
    volumes:
      - grafana_data:/var/lib/grafana
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.grafana.rule=Host(`${DOMAIN}`) && PathPrefix(`/grafana`)"
      - "traefik.http.routers.grafana.entrypoints=websecure"
      - "traefik.http.routers.grafana.tls.certresolver=letsencrypt"
      - "traefik.http.services.grafana.loadbalancer.server.port=3000"
    networks:
      - traefik-net
      - backend
    depends_on:
      - prometheus
      - loki

  # ============================================
  # Logs - Loki
  # ============================================
  
  loki:
    image: grafana/loki:latest
    container_name: loki
    restart: unless-stopped
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - loki_data:/loki
    networks:
      - backend

  # ============================================
  # Uptime Monitoring - Uptime Kuma
  # ============================================
  
  uptime-kuma:
    image: louislam/uptime-kuma:latest
    container_name: uptime-kuma
    restart: unless-stopped
    volumes:
      - uptime_kuma_data:/app/data
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.uptime.rule=Host(`${DOMAIN}`) && PathPrefix(`/uptime`)"
      - "traefik.http.routers.uptime.entrypoints=websecure"
      - "traefik.http.routers.uptime.tls.certresolver=letsencrypt"
      - "traefik.http.services.uptime.loadbalancer.server.port=3001"
      - "traefik.http.middlewares.uptime-strip.stripprefix.prefixes=/uptime"
      - "traefik.http.routers.uptime.middlewares=uptime-strip"
    networks:
      - traefik-net
      - backend

  # ============================================
  # LLM Observability - Langfuse
  # ============================================
  
  langfuse:
    image: langfuse/langfuse:latest
    container_name: langfuse
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      NEXTAUTH_SECRET: ${LANGFUSE_NEXTAUTH_SECRET}
      SALT: ${LANGFUSE_SECRET_KEY}
      NEXTAUTH_URL: https://${DOMAIN}/langfuse
      NEXT_PUBLIC_BASE_PATH: /langfuse
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.langfuse.rule=Host(`${DOMAIN}`) && PathPrefix(`/langfuse`)"
      - "traefik.http.routers.langfuse.entrypoints=websecure"
      - "traefik.http.routers.langfuse.tls.certresolver=letsencrypt"
      - "traefik.http.services.langfuse.loadbalancer.server.port=3000"
    networks:
      - traefik-net
      - backend
    depends_on:
      - postgres

# ============================================
# Networks (extend from core)
# ============================================

networks:
  traefik-net:
    external: true
  backend:
    external: true

# ============================================
# Volumes
# ============================================

volumes:
  prometheus_data:
  grafana_data:
  loki_data:
  uptime_kuma_data:
