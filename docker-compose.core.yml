version: '3.8'

# ============================================
# OpenClaw Stack - Core Services
# ============================================
#
# Essential services required for all deployments:
# - Traefik (reverse proxy + SSL)
# - OpenClaw (gateway + CLI)
# - Portainer (container management)
# - MinIO (S3-compatible storage)
# - Redis (cache + broker)
# - PostgreSQL (database)
# - Qdrant (vector database)
#
# RAM requirement: ~6-8 GB
# Usage:
#   docker compose -f docker-compose.core.yml [additional overrides] up -d

services:
  # ============================================
  # Reverse Proxy & SSL
  # ============================================
  
  traefik:
    image: traefik:v2.11
    container_name: traefik
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik_certs:/letsencrypt
    command:
      - "--api.dashboard=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`${DOMAIN}`) && PathPrefix(`/traefik`)"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.entrypoints=websecure"
      - "traefik.http.routers.dashboard.tls.certresolver=letsencrypt"
      - "traefik.http.middlewares.dashboard-strip.stripprefix.prefixes=/traefik"
      - "traefik.http.routers.dashboard.middlewares=dashboard-strip,auth"
      - "traefik.http.middlewares.auth.basicauth.users=admin:$$apr1$$8dGqfIjK$$VF8W8yKRxRdH7K8H0lZ.41"
    networks:
      - traefik-net

  # ============================================
  # OpenClaw - AI Assistant
  # ============================================
  
  openclaw-gateway:
    image: ${OPENCLAW_IMAGE:-openclaw:local}
    container_name: openclaw-gateway
    environment:
      HOME: /home/node
      TERM: xterm-256color
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN}
      CLAUDE_AI_SESSION_KEY: ${CLAUDE_AI_SESSION_KEY}
      CLAUDE_WEB_SESSION_KEY: ${CLAUDE_WEB_SESSION_KEY}
      CLAUDE_WEB_COOKIE: ${CLAUDE_WEB_COOKIE}
    volumes:
      - ${OPENCLAW_CONFIG_DIR:-./openclaw_state}:/home/node/.openclaw
      - ${OPENCLAW_WORKSPACE_DIR:-./workspace}:/home/node/.openclaw/workspace
    init: true
    restart: unless-stopped
    command:
      - "node"
      - "dist/index.js"
      - "gateway"
      - "--bind"
      - "lan"
      - "--port"
      - "18789"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.openclaw.rule=Host(`${DOMAIN}`) && PathPrefix(`/claw`)"
      - "traefik.http.routers.openclaw.entrypoints=websecure"
      - "traefik.http.routers.openclaw.tls.certresolver=letsencrypt"
      - "traefik.http.services.openclaw.loadbalancer.server.port=18789"
      - "traefik.http.middlewares.openclaw-strip.stripprefix.prefixes=/claw"
      - "traefik.http.routers.openclaw.middlewares=openclaw-strip"
    networks:
      - traefik-net
      - backend

  openclaw-cli:
    image: ${OPENCLAW_IMAGE:-openclaw:local}
    container_name: openclaw-cli
    environment:
      HOME: /home/node
      TERM: xterm-256color
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN}
      BROWSER: echo
      CLAUDE_AI_SESSION_KEY: ${CLAUDE_AI_SESSION_KEY}
      CLAUDE_WEB_SESSION_KEY: ${CLAUDE_WEB_SESSION_KEY}
      CLAUDE_WEB_COOKIE: ${CLAUDE_WEB_COOKIE}
    volumes:
      - ${OPENCLAW_CONFIG_DIR:-./openclaw_state}:/home/node/.openclaw
      - ${OPENCLAW_WORKSPACE_DIR:-./workspace}:/home/node/.openclaw/workspace
    stdin_open: true
    tty: true
    init: true
    entrypoint: ["node", "dist/index.js"]
    networks:
      - backend

  # ============================================
  # Container Management
  # ============================================
  
  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.portainer.rule=Host(`${DOMAIN}`) && PathPrefix(`/portainer`)"
      - "traefik.http.routers.portainer.entrypoints=websecure"
      - "traefik.http.routers.portainer.tls.certresolver=letsencrypt"
      - "traefik.http.services.portainer.loadbalancer.server.port=9000"
      - "traefik.http.middlewares.portainer-strip.stripprefix.prefixes=/portainer"
      - "traefik.http.routers.portainer.middlewares=portainer-strip"
    networks:
      - traefik-net

  # ============================================
  # Storage - MinIO (S3-compatible)
  # ============================================
  
  minio:
    image: minio/minio:latest
    container_name: minio
    restart: unless-stopped
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.minio-console.rule=Host(`${DOMAIN}`) && PathPrefix(`/minio`)"
      - "traefik.http.routers.minio-console.entrypoints=websecure"
      - "traefik.http.routers.minio-console.tls.certresolver=letsencrypt"
      - "traefik.http.services.minio-console.loadbalancer.server.port=9001"
      - "traefik.http.middlewares.minio-strip.stripprefix.prefixes=/minio"
      - "traefik.http.routers.minio-console.middlewares=minio-strip"
    networks:
      - traefik-net
      - backend

  # ============================================
  # Cache & Message Broker - Redis
  # ============================================
  
  redis:
    image: redis:7-alpine
    container_name: redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    networks:
      - backend

  redis-insight:
    image: redislabs/redisinsight:latest
    container_name: redis-insight
    restart: unless-stopped
    volumes:
      - redisinsight_data:/db
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.redis.rule=Host(`${DOMAIN}`) && PathPrefix(`/redis`)"
      - "traefik.http.routers.redis.entrypoints=websecure"
      - "traefik.http.routers.redis.tls.certresolver=letsencrypt"
      - "traefik.http.services.redis.loadbalancer.server.port=8001"
      - "traefik.http.middlewares.redis-strip.stripprefix.prefixes=/redis"
      - "traefik.http.routers.redis.middlewares=redis-strip"
    networks:
      - traefik-net
      - backend

  # ============================================
  # Database - PostgreSQL
  # ============================================
  
  postgres:
    image: postgres:15-alpine
    container_name: postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - backend

  # ============================================
  # Vector Database - Qdrant
  # ============================================
  
  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    restart: unless-stopped
    environment:
      QDRANT__SERVICE__API_KEY: ${QDRANT_API_KEY}
    volumes:
      - qdrant_data:/qdrant/storage
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.qdrant.rule=Host(`${DOMAIN}`) && PathPrefix(`/qdrant`)"
      - "traefik.http.routers.qdrant.entrypoints=websecure"
      - "traefik.http.routers.qdrant.tls.certresolver=letsencrypt"
      - "traefik.http.services.qdrant.loadbalancer.server.port=6333"
      - "traefik.http.middlewares.qdrant-strip.stripprefix.prefixes=/qdrant"
      - "traefik.http.routers.qdrant.middlewares=qdrant-strip"
    networks:
      - traefik-net
      - backend

# ============================================
# Networks
# ============================================

networks:
  traefik-net:
    driver: bridge
  backend:
    driver: bridge

# ============================================
# Volumes
# ============================================

volumes:
  traefik_certs:
  portainer_data:
  minio_data:
  redis_data:
  redisinsight_data:
  postgres_data:
  qdrant_data:
